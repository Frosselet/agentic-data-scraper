# ADR-002: Docker-based AWS Lambda Deployment Strategy with Full Playwright Support

**Status:** Proposed  
**Date:** 2025-09-04  
**Authors:** Fran√ßois Rosselet, Claude (Anthropic)
**Reviewers:** TBD  
**Implementation Branch:** `adr-002-docker-lambda-playwright`

## Context

The Agentic Data Scraper project generates AWS Lambda functions for web scraping pipelines that use Playwright for browser automation. However, traditional Lambda deployment approaches face significant constraints when including Playwright and Chromium:

**Current Limitations:**
- Lambda layers have a 50MB unzipped size limit
- Playwright + Chromium browser binaries exceed 200MB unzipped
- Lambda deployment packages are limited to 250MB unzipped for direct uploads
- Complex web scraping requires full browser capabilities, not just headless modes

**Technical Context:**
- AWS Lambda now supports container images up to 10GB in size
- Docker images for Lambda provide full Linux environment capabilities
- Our generated pipeline code needs to support complex web interactions
- Production deployments require consistent browser environments
- Cold start performance is critical for cost-effective operation
- Python 3.12+ provides significant performance improvements and modern async features
- Generated pipeline code will target Docker Lambda runtime with Python 3.12+
- Python 3.12 performance improvements reduce cold start times and execution duration

**Key Requirements:**
- Support for full Playwright browser automation (Chromium, Firefox, WebKit)
- Use Python 3.12+ as the base runtime for performance and async improvements
- Generated code should assume Docker runtime environment with Python 3.12+
- Optimize for Lambda execution environment and constraints
- Enable both headless and headed browser modes for debugging
- Maintain fast cold start times despite larger deployment size
- Support local development parity with production runtime
- Leverage Python 3.12 performance improvements for cold start optimization

## Decision

We will adopt **Docker container images with Python 3.12+** as the primary deployment strategy for AWS Lambda functions generated by our pipeline, with Playwright and Chromium pre-installed in the base image.

**Core Architecture:**
- Use Docker images with Python 3.12+ runtime for all generated Lambda deployments
- Create optimized base Docker image with Python 3.12+ and Playwright + Chromium pre-installed
- Generate Lambda code that assumes Docker runtime environment with Python 3.12+
- Implement multi-stage Docker builds for size optimization
- Support both headless and headed browser modes
- Optimize Docker layer caching for faster builds
- Leverage Python 3.12 performance improvements and modern async features

**Generated Code Assumptions:**
- Lambda runtime will have Python 3.12+ with full Playwright browser binaries available
- No size constraints for browser automation libraries
- Full Linux environment with necessary system dependencies
- Consistent browser versions across all deployments
- Access to display server for headed mode debugging
- Python 3.12+ performance optimizations and modern async/await patterns
- Memory and timeout configurations optimized for Python 3.12+ performance

**Deployment Strategy:**
- Base image template with common dependencies
- Pipeline-specific images inherit from base image
- Container Registry (ECR) for image distribution
- Automated image building and deployment via CI/CD

## Consequences

### Positive
- **No size constraints**: 10GB limit removes Playwright packaging restrictions
- **Full browser support**: Complete Chromium, Firefox, and WebKit capabilities
- **Python 3.12+ performance**: Significant runtime performance improvements and modern async features
- **Consistent environments**: Docker ensures identical runtime across dev/prod
- **Better debugging**: Support for headed browser modes in development
- **Simplified packaging**: No need to optimize for Lambda layer limits
- **Future-proof architecture**: Container-first approach aligns with AWS direction
- **Local development parity**: Same Docker image can run locally and in Lambda
- **Version consistency**: Locked browser and Python versions prevent environment drift
- **Cold start optimization**: Python 3.12 improvements reduce function initialization time

### Negative
- **Larger deployment packages**: Docker images are significantly larger than ZIP files
- **Increased deployment complexity**: Container registry management and image building
- **Longer cold starts**: Larger images may increase Lambda cold start times
- **Storage costs**: ECR storage costs for Docker images
- **Build complexity**: Multi-stage Docker builds require more sophisticated CI/CD
- **Local development setup**: Developers need Docker environment setup
- **Network dependency**: Requires pulling images from container registry

### Neutral
- **Different deployment workflow**: Teams must learn container-based Lambda deployment
- **Registry management**: Need to manage Docker image lifecycle and cleanup
- **Build time trade-offs**: Longer initial builds but better caching for incremental changes
- **Memory considerations**: May require higher Lambda memory configurations
- **Monitoring changes**: Different metrics and logging patterns for container-based functions

## Implementation

### Acceptance Criteria
- [ ] Base Dockerfile template with Playwright + Chromium pre-installed
- [ ] Multi-stage Docker build configuration for size optimization
- [ ] Code generation templates updated for Docker Lambda runtime
- [ ] ECR repository setup and automated image publishing
- [ ] Lambda function configuration templates for container deployment
- [ ] Local development Docker Compose setup for testing
- [ ] Documentation for Docker-based deployment workflow
- [ ] Performance benchmarks comparing Docker vs ZIP deployment cold starts
- [ ] Cost analysis of ECR storage vs traditional Lambda packaging

### Implementation Steps

1. **Create Base Docker Image with Python 3.12+**
   - Design multi-stage Dockerfile with Python 3.12+ and Playwright pre-installed
   - Optimize layer caching for common dependencies
   - Configure proper Lambda runtime interface client for Python 3.12+
   - Test browser functionality in Lambda execution environment
   - Benchmark cold start performance and memory usage with Python 3.12+
   - Implement Python 3.12+ specific optimizations for cold start reduction

2. **Update Code Generation Templates**
   - Modify generated Lambda handlers to assume Docker environment with Python 3.12+
   - Remove Playwright installation code from generated functions
   - Add Docker-specific configuration templates
   - Update memory and timeout recommendations for Python 3.12+ container functions
   - Include environment variable templates for browser configuration
   - Generate code using Python 3.12+ async/await patterns and performance optimizations

3. **Configure Container Registry**
   - Set up Amazon ECR repository for base and generated images
   - Configure automated image building in CI/CD pipeline
   - Implement image tagging strategy for version management
   - Set up image scanning and security policies
   - Configure repository lifecycle policies

4. **Development Tooling**
   - Create Docker Compose setup for local development
   - Add scripts for building and testing Docker images locally
   - Configure VS Code dev container setup
   - Create debugging configuration for headed browser modes
   - Document local development workflow

5. **Deployment Pipeline Updates**
   - Update AWS CDK/CloudFormation templates for container Lambda
   - Configure automated Docker image building and pushing
   - Update deployment scripts to use container images
   - Add rollback mechanisms for failed container deployments
   - Configure monitoring and alerting for container-based functions

6. **Performance Optimization**
   - Implement Docker layer optimization strategies
   - Configure Lambda provisioned concurrency for critical functions
   - Add cold start monitoring and alerting
   - Create performance comparison benchmarks
   - Document memory and timeout optimization guidelines

### Migration Strategy

**New Deployments:**
- All new generated pipelines will use Docker-based deployment by default
- Legacy ZIP-based deployment will remain available as fallback option
- Documentation will guide users toward Docker-first approach

**Existing Deployments:**
- Existing ZIP-based Lambda functions can continue operating unchanged
- Migration guide will be provided for moving existing functions to Docker
- Gradual migration approach with side-by-side testing capabilities
- Performance comparison tools to validate migration benefits

**Backwards Compatibility:**
- Code generation will support both deployment modes initially
- Feature flags to control deployment strategy per pipeline
- Clear deprecation timeline for ZIP-based deployment (if applicable)

## Monitoring and Success Metrics

**Performance Metrics:**
- Cold start duration (target: <5 seconds for Docker vs ZIP baseline)
- Memory utilization patterns for container-based functions
- Function execution time improvements with pre-installed browsers
- Image pull time from ECR during cold starts

**Operational Metrics:**
- Docker image build success rate (target: >99%)
- ECR storage costs vs traditional packaging
- Deployment success rate for container-based functions
- Developer onboarding time with Docker workflow

**Quality Metrics:**
- Browser automation test success rate in Lambda environment
- Cross-browser compatibility test coverage
- Security scan results for base Docker images
- Function reliability and error rates

**Warning Signs:**
- Cold start times exceeding 10 seconds consistently
- High ECR storage costs without corresponding value
- Frequent Docker build failures or image corruption
- Developer complaints about local development complexity
- Security vulnerabilities in base Docker images

## References

- [AWS Lambda Container Image Support](https://docs.aws.amazon.com/lambda/latest/dg/images-create.html)
- [Playwright Docker Documentation](https://playwright.dev/docs/docker)
- [AWS Lambda Runtime Interface Emulator](https://github.com/aws/aws-lambda-runtime-interface-emulator)
- [Docker Multi-stage Builds](https://docs.docker.com/develop/dev-best-practices/multistage-build/)
- [Amazon ECR Best Practices](https://docs.aws.amazon.com/AmazonECR/latest/userguide/best-practices.html)
- [AWS Lambda Performance Optimization](https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html)
- [Playwright System Requirements](https://playwright.dev/docs/intro#system-requirements)
- [AWS Lambda Container Image Pricing](https://aws.amazon.com/lambda/pricing/)

## Revision History

| Date | Author | Changes |
|------|--------|---------|
| 2025-09-04 | Development Team | Initial version |